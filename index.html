<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タイムシートPDF解析ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+JP:wght@400;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

<div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Header -->
    <header class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">タイムシート解析エディタ</h1>
        <p class="text-gray-600">高精度OCR解析とコントロール機能を搭載</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Sidebar: Upload & Settings -->
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    ファイルアップロード
                </h2>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer" id="drop-zone">
                    <input type="file" id="pdf-input" class="hidden" accept="application/pdf">
                    <p class="text-sm text-gray-500" id="file-name-display">PDFファイルをドラッグ＆ドロップ、またはクリック</p>
                </div>

                <div class="mt-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">解析モード</label>
                        <select id="analysis-mode" class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">全ページを解析</option>
                            <option value="select">ページを指定して解析</option>
                        </select>
                    </div>

                    <div id="page-selection" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ページ番号 (例: 1, 3-5)</label>
                        <input type="text" id="page-range" placeholder="1, 2" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                    </div>

                    <div id="action-buttons" class="space-y-2">
                        <button id="start-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            解析を開始する
                        </button>
                        
                        <div id="control-panel" class="hidden flex gap-2">
                            <button id="pause-btn" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 rounded-md transition-all">
                                一時停止
                            </button>
                            <button id="stop-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-md transition-all">
                                停止
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Container -->
            <div id="status-container" class="hidden bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700" id="status-text">準備完了</span>
                    <span class="text-xs text-gray-500" id="progress-percent">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="loading-spinner" class="mt-4 flex flex-col items-center hidden">
                    <div class="spinner"></div>
                    <p class="text-[10px] text-gray-400 mt-2 uppercase tracking-widest">Processing Page</p>
                </div>
            </div>
        </div>

        <!-- Main View -->
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 min-h-[500px]">
                <div class="flex flex-col sm:flex-row items-center justify-between mb-6 gap-4 border-b border-gray-100 pb-4">
                    <h2 class="text-lg font-semibold text-gray-900">解析結果プレビュー</h2>
                    <button id="download-zip-btn" class="hidden flex items-center text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700 py-2.5 px-6 rounded-md shadow-sm transition-all">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        まとめて保存 (.zip)
                    </button>
                </div>

                <div id="results-list" class="space-y-10">
                    <div id="placeholder-text" class="text-center py-32 text-gray-400">
                        <svg class="w-12 h-12 mx-auto mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <p>PDFをアップロードして解析を開始してください</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const apiKey = "";
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    let uploadedFile = null;
    let resultsData = [];
    let isPaused = false;
    let isStopped = false;

    // DOM Elements
    const dropZone = document.getElementById('drop-zone');
    const pdfInput = document.getElementById('pdf-input');
    const fileNameDisplay = document.getElementById('file-name-display');
    const startBtn = document.getElementById('start-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const stopBtn = document.getElementById('stop-btn');
    const controlPanel = document.getElementById('control-panel');
    const analysisMode = document.getElementById('analysis-mode');
    const pageSelection = document.getElementById('page-selection');
    const pageRangeInput = document.getElementById('page-range');
    const statusContainer = document.getElementById('status-container');
    const statusText = document.getElementById('status-text');
    const progressPercent = document.getElementById('progress-percent');
    const progressBar = document.getElementById('progress-bar');
    const loadingSpinner = document.getElementById('loading-spinner');
    const resultsList = document.getElementById('results-list');
    const placeholderText = document.getElementById('placeholder-text');
    const downloadZipBtn = document.getElementById('download-zip-btn');

    // Controls
    dropZone.onclick = () => pdfInput.click();
    pdfInput.onchange = (e) => e.target.files.length && handleFile(e.target.files[0]);
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-blue-400'); };
    dropZone.ondragleave = () => dropZone.classList.remove('border-blue-400');
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-blue-400');
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    };

    function handleFile(file) {
        if (file.type !== 'application/pdf') {
            alert("PDFファイルのみ対応しています。");
            return;
        }
        uploadedFile = file;
        fileNameDisplay.textContent = file.name;
        startBtn.disabled = false;
    }

    analysisMode.onchange = () => pageSelection.classList.toggle('hidden', analysisMode.value !== 'select');

    pauseBtn.onclick = () => {
        isPaused = !isPaused;
        pauseBtn.textContent = isPaused ? "再開" : "一時停止";
        pauseBtn.className = isPaused 
            ? "flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-md transition-all"
            : "flex-1 bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 rounded-md transition-all";
        if (!isPaused) statusText.textContent = "解析を再開しました";
        else statusText.textContent = "一時停止中...";
    };

    stopBtn.onclick = () => {
        isStopped = true;
        isPaused = false;
        statusText.textContent = "停止しています...";
    };

    async function pdfToImages(file, pageIndices) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        const images = [];
        const indices = pageIndices || Array.from({ length: pdf.numPages }, (_, i) => i + 1);

        for (const pageIdx of indices) {
            if (pageIdx > pdf.numPages || pageIdx < 1) continue;
            const page = await pdf.getPage(pageIdx);
            const viewport = page.getViewport({ scale: 2.2 }); // 少し解像度を上げて精度向上
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: context, viewport: viewport }).promise;
            images.push({ pageNumber: pageIdx, base64: canvas.toDataURL('image/png').split(',')[1] });
        }
        return images;
    }

    async function analyzeWithGemini(base64Image, retryCount = 0) {
        const systemPrompt = `あなたはプロフェッショナルな事務解析エージェントです。
画像からタイムシートの表情報を1行も漏らさず抽出してください。
注意点：
1. 氏名の横にある「(数字)」はスタッフ番号(staff_no)として分離してください。
2. 表が空欄に見えても、日付や曜日の行が存在する場合は必ず daily_records に含めてください。
3. 表の内容が読み取れない場合でも、JSONの構造を維持し、値を空文字 "" にして返してください。絶対に出力を省略しないでください。

出力フォーマット(JSON):
{
  "period": "対象期間",
  "client": "派遣先名",
  "workplace": "就業先名",
  "staff_name": "氏名(番号を含まない)",
  "staff_no": "カッコ内のスタッフ番号のみ",
  "daily_records": [
    {"date": "日", "day": "曜", "category": "区分", "start_time": "始業", "end_time": "終業", "break_time": "休息"}
  ]
}`;

        const payload = {
            contents: [{
                parts: [
                    { text: "このタイムシート画像を解析してください。表が白紙に見える場合でも、記載されている最小限の情報を抽出してください。" },
                    { inlineData: { mimeType: "image/png", data: base64Image } }
                ]
            }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: { 
                responseMimeType: "application/json",
                temperature: 0 // 決定論的な出力を促し、ランダムな空出力を抑制
            }
        };

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error('API Error');
            const result = await response.json();
            const data = JSON.parse(result.candidates[0].content.parts[0].text);

            // 精度向上策: daily_recordsが空、または極端に少ない場合に1回だけリトライ
            if ((!data.daily_records || data.daily_records.length < 5) && retryCount === 0) {
                console.log("Detections low, retrying...");
                return await analyzeWithGemini(base64Image, 1);
            }

            return data;
        } catch (error) {
            if (retryCount < 2) {
                await new Promise(r => setTimeout(r, 2000));
                return await analyzeWithGemini(base64Image, retryCount + 1);
            }
            throw error;
        }
    }

    startBtn.onclick = async () => {
        if (!uploadedFile) return;
        
        // Init UI
        resultsList.innerHTML = '';
        placeholderText.classList.add('hidden');
        statusContainer.classList.remove('hidden');
        controlPanel.classList.remove('hidden');
        startBtn.classList.add('hidden');
        downloadZipBtn.classList.add('hidden');
        
        resultsData = [];
        isPaused = false;
        isStopped = false;

        let targetPages = null;
        if (analysisMode.value === 'select') {
            targetPages = pageRangeInput.value.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
        }

        try {
            statusText.textContent = "PDFを準備中...";
            const images = await pdfToImages(uploadedFile, targetPages);

            for (let i = 0; i < images.length; i++) {
                // Check Pause State
                while (isPaused) {
                    await new Promise(r => setTimeout(r, 500));
                    if (isStopped) break;
                }
                
                // Check Stop State
                if (isStopped) break;

                const percent = Math.round((i / images.length) * 100);
                progressPercent.textContent = `${percent}%`;
                progressBar.style.width = `${percent}%`;
                statusText.textContent = `${i + 1} / ${images.length} ページ目を解析中...`;
                loadingSpinner.classList.remove('hidden');

                try {
                    const data = await analyzeWithGemini(images[i].base64);
                    data.page_idx = images[i].pageNumber;
                    
                    if (data.staff_name && data.staff_name.includes('(')) {
                        data.staff_name = data.staff_name.split('(')[0].trim();
                    }

                    const periodMatch = data.period.match(/(\d{4})[^\d](\d{1,2})/);
                    const yearMonth = periodMatch ? `${periodMatch[1]}${periodMatch[2].padStart(2, '0')}` : "000000";
                    data.suggested_filename = `${yearMonth}_タイムシート_${data.staff_name}_${data.staff_no || ''}`.replace(/_+$/g, '').replace(/__+/g, '_');

                    resultsData.push(data);
                    displayResult(data);
                } catch (err) {
                    console.error("Page analysis failed", err);
                }
            }

            statusText.textContent = isStopped ? "解析を停止しました" : "解析完了";
            progressPercent.textContent = `100%`;
            progressBar.style.width = `100%`;
            if (resultsData.length > 0) downloadZipBtn.classList.remove('hidden');
        } catch (error) {
            statusText.textContent = "重大なエラーが発生しました";
        } finally {
            controlPanel.classList.add('hidden');
            startBtn.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
        }
    };

    function displayResult(data) {
        const div = document.createElement('div');
        div.className = "bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden animate-fade-in mb-6";
        
        let tableRows = data.daily_records.map(r => `
            <tr class="hover:bg-gray-50 text-xs">
                <td class="px-3 py-2 border-b border-gray-100 font-mono">${r.date || ''}</td>
                <td class="px-3 py-2 border-b border-gray-100 text-gray-500">${r.day || ''}</td>
                <td class="px-3 py-2 border-b border-gray-100">${r.category || ''}</td>
                <td class="px-3 py-2 border-b border-gray-100 font-mono">${r.start_time || ''}</td>
                <td class="px-3 py-2 border-b border-gray-100 font-mono">${r.end_time || ''}</td>
                <td class="px-3 py-2 border-b border-gray-100 font-mono">${r.break_time || ''}</td>
            </tr>
        `).join('');

        div.innerHTML = `
            <div class="p-5 bg-slate-50 border-b border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-[10px] font-bold text-slate-400 border border-slate-300 px-2 py-0.5 rounded">PAGE ${data.page_idx}</span>
                    <span class="text-[10px] font-mono text-slate-400 truncate ml-4">${data.suggested_filename}.csv</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-y-3 gap-x-6 text-sm">
                    <div class="flex flex-col"><span class="text-[9px] text-slate-400 font-bold uppercase">対象期間</span><span class="font-semibold">${data.period}</span></div>
                    <div class="flex flex-col"><span class="text-[9px] text-slate-400 font-bold uppercase">氏名</span><span class="font-semibold">${data.staff_name}</span></div>
                    <div class="flex flex-col"><span class="text-[9px] text-slate-400 font-bold uppercase">スタッフ番号</span><span class="font-bold text-blue-600">${data.staff_no || '---'}</span></div>
                    <div class="flex flex-col"><span class="text-[9px] text-slate-400 font-bold uppercase">派遣先</span><span class="font-medium text-slate-600">${data.client}</span></div>
                    <div class="flex flex-col md:col-span-2"><span class="text-[9px] text-slate-400 font-bold uppercase">就業先</span><span class="font-medium text-slate-600">${data.workplace}</span></div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-100/50 text-slate-400 text-[9px] font-bold uppercase">
                        <tr>
                            <th class="px-3 py-2 border-b border-gray-200">日付</th>
                            <th class="px-3 py-2 border-b border-gray-200">曜日</th>
                            <th class="px-3 py-2 border-b border-gray-200">区分</th>
                            <th class="px-3 py-2 border-b border-gray-200">始業</th>
                            <th class="px-3 py-2 border-b border-gray-200">終業</th>
                            <th class="px-3 py-2 border-b border-gray-200">休息</th>
                        </tr>
                    </thead>
                    <tbody class="text-slate-700">${tableRows}</tbody>
                </table>
            </div>
        `;
        resultsList.prepend(div); // 最新を上に表示
    }

    function convertToCSV(data) {
        const metadata = [
            ["対象期間", data.period],
            ["派遣先", data.client],
            ["就業先", data.workplace],
            ["スタッフ氏名", data.staff_name],
            ["スタッフ番号", data.staff_no || ""],
            [] 
        ];
        const tableHeader = ["日付", "曜日", "区分", "始業", "終業", "休息"];
        const tableRows = data.daily_records.map(r => [r.date, r.day, r.category, r.start_time, r.end_time, r.break_time]);
        const allRows = [...metadata, tableHeader, ...tableRows];

        const csvString = allRows.map(row => 
            row.map(cell => `"${(cell || "").toString().replace(/"/g, '""')}"`).join(",")
        ).join("\n");

        return "\uFEFF" + csvString;
    }

    downloadZipBtn.onclick = async () => {
        if (resultsData.length === 0) return;
        statusText.textContent = "Zipパッケージを作成中...";
        const zip = new JSZip();
        resultsData.forEach(data => {
            zip.file(`${data.suggested_filename}.csv`, convertToCSV(data));
        });
        const zipBlob = await zip.generateAsync({ type: "blob" });
        const url = URL.createObjectURL(zipBlob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `タイムシート出力_${new Date().getTime()}.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        statusText.textContent = "ダウンロードが完了しました";
    };
</script>

</body>
</html>
